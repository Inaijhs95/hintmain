<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>あいつを探せ！</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* リセットスタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* HUDのスタイル */
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 16px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
        }

        /* 手配書のスタイル */
        #wanted-poster {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 150px;
            background-color: #fff;
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 5px;
            text-align: center;
            z-index: 1000;
            color: #000;
        }

        #wanted-poster img {
            width: 80px;
            height: 80px;
        }

        #wanted-poster p {
            margin-top: 5px;
            font-weight: bold;
        }

        /* ゲームエリアのスタイル */
        #game-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .character {
            position: absolute;
            width: 40px;
            height: 40px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }

        /* メッセージのスタイル */
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1001;
            display: none;
        }

        #message h2 {
            margin-bottom: 10px;
            color: #fff;
        }

        #message a, #message button {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #007BFF;
            color: #fff;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* 暗闇オーバーレイのスタイル */
        #darkness-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 500;
            clip-path: circle(50px at center);
            transition: clip-path 1s linear;
        }

        /* レスポンシブ調整 */
        @media (max-width: 600px) {
            #hud {
                font-size: 14px;
            }

            #wanted-poster {
                width: 80px;
                height: 120px;
            }

            #wanted-poster img {
                width: 60px;
                height: 60px;
            }

            .character {
                width: 35px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- HUD: レベル、タイマー、スコア -->
        <div id="hud">
            <div id="level">レベル: 1</div>
            <div id="timer">残り時間: 15.0秒</div>
            <div id="score">クリア数: 0</div>
        </div>

        <!-- 手配書: 探すキャラクターの表示 -->
        <div id="wanted-poster">
            <img id="target-image" src="" alt="探すキャラクター">
            <p>探してください</p>
        </div>

        <!-- ゲームエリア: キャラクターが表示される場所 -->
        <div id="game-area"></div>

        <!-- メッセージ表示: ゲームクリアまたはゲームオーバー時 -->
        <div id="message">
            <h2 id="final-message"></h2>
            <a href="https://inaijhs95.github.io/4lamp/?link=1" id="get-link" target="_blank" style="display: none;">♣のトランプをゲットする</a>
            <button id="retry-button" style="display: none;">再チャレンジ</button>
        </div>

        <!-- 暗闇オーバーレイ -->
        <div id="darkness-overlay"></div>
    </div>

    <script>
        // キャラクターの種類（panda.pngを除く4種）
        const CHARACTERS = [
            'gorilla.png',
            'tengu.png',
            'namahage.png',
            'koala.png'
        ];

        // ゲーム設定
        const TOTAL_CHARACTERS = 100;
        const INITIAL_TIME = 15.0;
        const TIME_DECREMENT = 0.3;
        const MIN_TIME = 5.0;
        const TOTAL_LEVELS = 4;

        // レベルごとの設定
        const levels = [
            {
                name: '静止画',
                dynamic: false,
                variableSpeed: false,
                darkness: false
            },
            {
                name: '無作為に移動',
                dynamic: true,
                variableSpeed: false,
                darkness: false
            },
            {
                name: '暗闇と照らされる範囲の移動',
                dynamic: false,
                variableSpeed: false,
                darkness: true
            },
            {
                name: '無作為に移動し、スピードがバラバラ',
                dynamic: true,
                variableSpeed: true,
                darkness: false
            }
        ];

        // ゲームステータス
        let currentLevelIndex = 0;
        let score = 0;
        let timeLimit = INITIAL_TIME;
        let timerInterval = null;
        let darknessInterval = null;
        let lightOn = false; // 暗闇ステージでの明暗切替フラグ

        // DOM要素
        const gameArea = document.getElementById('game-area');
        const levelDisplay = document.getElementById('level');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const wantedPoster = document.getElementById('wanted-poster');
        const targetImage = document.getElementById('target-image');
        const messageDiv = document.getElementById('message');
        const finalMessage = document.getElementById('final-message');
        const getLink = document.getElementById('get-link');
        const retryButton = document.getElementById('retry-button');
        const darknessOverlay = document.getElementById('darkness-overlay');

        // 初期化
        window.onload = startGame;

        // ゲーム開始
        function startGame() {
            currentLevelIndex = 0;
            score = 0;
            timeLimit = INITIAL_TIME;
            scoreDisplay.textContent = `クリア数: ${score}`;
            messageDiv.style.display = 'none';
            startLevel();
        }

        // レベル開始
        function startLevel() {
            if (score >= 4) {
                showFinalMessage(true);
                return;
            }

            if (currentLevelIndex >= levels.length) {
                currentLevelIndex = 0; // レベルをループさせる場合
            }

            const currentLevel = levels[currentLevelIndex];
            levelDisplay.textContent = `レベル: ${currentLevelIndex + 1}`;
            scoreDisplay.textContent = `クリア数: ${score}`;
            timeLimit = Math.max(INITIAL_TIME - TIME_DECREMENT * score, MIN_TIME);
            timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;

            // ゲームエリアをクリア
            gameArea.innerHTML = '';

            // 暗闇設定
            if (currentLevel.darkness) {
                addDarknessEffect();
            } else {
                darknessOverlay.style.display = 'none';
                darknessOverlay.style.clipPath = 'circle(0px at center)';
            }

            // 探すキャラクターをランダムに選択
            const targetCharacter = CHARACTERS[Math.floor(Math.random() * CHARACTERS.length)];
            targetImage.src = targetCharacter;

            // 画像を配置
            placeCharacters(targetCharacter, currentLevel);

            // タイマー開始
            startTimer();

            // レベルインデックスを更新
            currentLevelIndex++;
        }

        // キャラクターの配置
        function placeCharacters(targetCharacter, levelConfig) {
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;

            // ターゲットキャラクターを1つ選択
            const targetCount = 1;
            const distractorCount = TOTAL_CHARACTERS - targetCount;

            // ターゲットを配置
            const targetPosition = getRandomPosition(areaWidth, areaHeight);
            createCharacter(targetCharacter, targetPosition.x, targetPosition.y, true, levelConfig);

            // ディストラクターを配置
            for (let i = 0; i < distractorCount; i++) {
                let character;
                do {
                    character = CHARACTERS[Math.floor(Math.random() * CHARACTERS.length)];
                } while (character === targetCharacter);
                const pos = getRandomPosition(areaWidth, areaHeight);
                createCharacter(character, pos.x, pos.y, false, levelConfig);
            }
        }

        // キャラクターの作成
        function createCharacter(character, x, y, isTarget, levelConfig) {
            const img = document.createElement('img');
            img.src = character;
            img.classList.add('character');
            img.style.left = `${x}px`;
            img.style.top = `${y}px`;
            img.dataset.type = isTarget ? 'target' : 'distractor';

            // 動的移動の設定
            if (levelConfig.dynamic) {
                const speed = levelConfig.variableSpeed ? getRandomSpeed() : 2;
                img.dataset.speed = speed;
                moveCharacter(img, speed);
            }

            // タップとクリックイベントの設定
            img.addEventListener('click', onCharacterClick);
            img.addEventListener('touchstart', onCharacterClick);

            gameArea.appendChild(img);
        }

        // キャラクターの移動
        function moveCharacter(img, speed) {
            let directionX = Math.random() < 0.5 ? -1 : 1;
            let directionY = Math.random() < 0.5 ? -1 : 1;

            function animate() {
                let x = parseFloat(img.style.left);
                let y = parseFloat(img.style.top);

                const areaWidth = gameArea.clientWidth;
                const areaHeight = gameArea.clientHeight;
                const imgWidth = img.clientWidth;
                const imgHeight = img.clientHeight;

                // 移動
                x += directionX * speed;
                y += directionY * speed;

                // 画面端で方向を反転
                if (x <= 0 || x >= areaWidth - imgWidth) directionX *= -1;
                if (y <= 0 || y >= areaHeight - imgHeight) directionY *= -1;

                img.style.left = `${x}px`;
                img.style.top = `${y}px`;

                // 次のフレームで再度移動
                img.animationFrame = requestAnimationFrame(animate);
            }

            animate();
        }

        // キャラクタークリック時の処理
        function onCharacterClick(event) {
            const type = event.target.dataset.type;
            if (type === 'target') {
                // ターゲットをクリックした場合
                clearInterval(timerInterval);
                if (levels[currentLevelIndex - 1].darkness) {
                    clearInterval(darknessInterval);
                }
                cancelAnimationFrame(event.target.animationFrame);
                score++;
                startLevel();
            } else {
                // ディストラクターをクリックした場合（必要に応じて処理を追加）
                // 例: ミスカウント、エフェクト表示など
            }
        }

        // タイマーの開始
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLimit -= 0.1;
                if (timeLimit <= 0) {
                    clearInterval(timerInterval);
                    gameOver();
                } else {
                    timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
                }
            }, 100);
        }

        // ゲームオーバー時の処理
        function gameOver() {
            // ゲームオーバー処理
            gameArea.innerHTML = '';
            clearInterval(timerInterval);
            if (levels[currentLevelIndex - 1].darkness) {
                clearInterval(darknessInterval);
            }
            messageDiv.style.display = 'block';
            finalMessage.textContent = 'ゲームオーバー！';
            getLink.style.display = 'none';
            retryButton.style.display = 'inline-block';
        }

        // 最終メッセージの表示
        function showFinalMessage(isClear) {
            // ゲームクリア時のメッセージ表示
            gameArea.innerHTML = '';
            messageDiv.style.display = 'block';
            if (isClear) {
                finalMessage.textContent = 'おめでとうございます！';
                getLink.style.display = 'inline-block';
                retryButton.style.display = 'none';
            } else {
                finalMessage.textContent = 'もう一度挑戦してください！';
                getLink.style.display = 'none';
                retryButton.style.display = 'inline-block';
            }
        }

        // 暗闇効果の追加
        function addDarknessEffect(levelConfig) {
            darknessOverlay.style.display = 'block';
            darknessOverlay.style.clipPath = 'circle(0px at center)';
            lightOn = false;

            // 1秒ごとに明暗を切り替える
            darknessInterval = setInterval(() => {
                lightOn = !lightOn;
                if (lightOn) {
                    // ランダムな位置に照らす
                    const x = Math.random() * gameArea.clientWidth;
                    const y = Math.random() * gameArea.clientHeight;
                    darknessOverlay.style.clipPath = `circle(100px at ${x}px ${y}px)`;
                } else {
                    // 全画面を暗闇に戻す
                    darknessOverlay.style.clipPath = `circle(0px at center)`;
                }
            }, 1000);
        }

        // ランダムな位置の取得
        function getRandomPosition(width, height) {
            const x = Math.random() * (width - 40); // 画像の幅を考慮
            const y = Math.random() * (height - 40); // 画像の高さを考慮
            return { x, y };
        }

        // ランダムな速度の取得
        function getRandomSpeed() {
            return Math.random() * 3 + 1; // スピード1〜4
        }

        // リトライボタンの設定
        retryButton.addEventListener('click', () => {
            messageDiv.style.display = 'none';
            startGame();
        });

        // ウィンドウリサイズ時の対応
        window.addEventListener('resize', () => {
            // 必要に応じてゲームエリアの再配置や調整を行います
        });
    </script>
</body>
</html>
