<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>イナイの救出シミュレーション</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 全体スタイル */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 10px;
        }
        #game-container {
            background-color: #fff;
            border: 2px solid #ccc;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 90vh;
            text-align: center;
            position: relative;
        }
        /* ダイアログスタイル */
        #dialogue {
            margin-top: 20px;
            min-height: 100px;
        }
        .character {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .character img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }
        /* オプションボタンスタイル */
        .options button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s;
        }
        .options button:hover {
            background-color: #45a049;
        }
        /* ダイヤルパッドスタイル */
        .dial-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .dial-buttons button {
            background-color: #f0f0f0;
            width: 100%;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dial-buttons button:hover {
            background-color: #ddd;
        }
        /* 電話をかけるボタンスタイル */
        #phone button.call-button {
            margin-top: 20px;
            padding: 15px;
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background-color: #4CAF50;
            background-image: url('phone-icon.png');
            background-size: 30px 30px;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #phone button.call-button:hover {
            background-color: #45a049;
        }
        /* 電話画面枠 */
        #phone {
            display: none;
            margin-top: 20px;
            border: 2px solid #000;
            border-radius: 30px;
            padding: 20px;
            background-color: #fff;
            position: relative;
        }
        /* ダイヤル表示スタイル */
        #phone-display {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 10px;
            font-family: 'Courier New', Courier, monospace;
            margin-bottom: 20px;
            text-align: center;
            min-height: 30px;
            word-break: break-all;
            font-size: 18px;
        }
        /* メッセージスタイル */
        #message {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6ffe6;
            border: 1px solid #b3ffb3;
            border-radius: 10px;
            display: none;
            text-align: left;
        }
        /* エンドメッセージスタイル */
        #end-message {
            margin-top: 10px; /* 上部の余白を削除 */
            text-align: center;
            display: none;
        }
        #end-message .character img {
            width: 60px;
            height: 60px;
        }
        /* バックボタンスタイル */
        .back-button {
            margin-top: 20px;
            padding: 10px 20px;
            width: auto;
            font-size: 16px;
            cursor: pointer;
            background-color: #f44336;
            border: none;
            border-radius: 10px;
            color: white;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #da190b;
        }
        /* ロックメッセージ */
        #lock-message {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffe6e6;
            border: 1px solid #ffb3b3;
            border-radius: 10px;
        }
        /* スマホ風枠 */
        #game-container::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 5px;
            background-color: #ccc;
            border-radius: 10px;
        }
        /* レスポンシブテキスト */
        p {
            font-size: 16px;
            line-height: 1.5;
            margin: 5px 0;
        }
        @media (max-width: 400px) {
            .character img {
                width: 40px;
                height: 40px;
            }
            .dial-buttons button {
                height: 50px;
                font-size: 18px;
            }
            #phone-display {
                font-size: 16px;
                padding: 8px;
            }
            p {
                font-size: 14px;
            }
            #game-container {
                border-radius: 15px;
            }
            #phone {
                border-radius: 20px;
            }
            #end-message .character img {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- トップページ -->
    <div id="top-page">
        <img src="allinai.png" alt="All Inai" style="max-width: 100%; height: auto;">
        <button onclick="startConversation()">イナイと話す</button>
    </div>

    <!-- ゲームコンテンツ -->
    <div id="game-content" style="display: none;">
        <div id="dialogue">
            <div class="character" id="inai-dialogue">
                <img src="komari.png" alt="イナイ">
                <p>実は困ってるんだ・・・</p>
            </div>
        </div>
        <div class="options" id="options">
            <button onclick="selectOption('how_are_you')">どうしたの？</button>
            <button onclick="selectOption('busy_now')">今忙しいから。</button>
        </div>
        <div id="phone">
            <div id="phone-display">ダイヤル: </div>
            <div class="dial-buttons">
                <button onclick="dialNumber('1')">1</button>
                <button onclick="dialNumber('2')">2</button>
                <button onclick="dialNumber('3')">3</button>
                <button onclick="dialNumber('4')">4</button>
                <button onclick="dialNumber('5')">5</button>
                <button onclick="dialNumber('6')">6</button>
                <button onclick="dialNumber('7')">7</button>
                <button onclick="dialNumber('8')">8</button>
                <button onclick="dialNumber('9')">9</button>
                <button onclick="dialNumber('*')">*</button>
                <button onclick="dialNumber('0')">0</button>
                <button onclick="dialNumber('#')">#</button>
            </div>
            <!-- 「電話をかける」ボタンを1つに統一 -->
            <button class="call-button" onclick="callService()"></button>
        </div>
        <div id="message"></div>
        <div id="end-message">
            <div class="character" id="end-dialogue">
                <img src="arigato.png" alt="イナイ">
                <p>本当にありがとう！君のおかげで家族の無事が分かったよ！これはお礼だよ。</p>
            </div>
            <button class="back-button" onclick="receiveReward()">受け取る</button>
        </div>
    </div>

    <!-- ロックメッセージ -->
    <div id="lock-message">
        <p>今は話しかけないで</p>
        <button class="back-button" onclick="goToTop()">トップページに戻る</button>
    </div>
</div>

<script>
    let dialedNumber = '';
    let negativeChoicesCount = 0;
    const maxNegativeChoices = 3;
    let isGameLocked = false;
    let hasShownLockedPopup = false; // ポップアップ表示のフラグ

    // 初期化: ローカルストレージからカウントを取得
    window.onload = function() {
        const storedCount = localStorage.getItem('negativeChoicesCount');
        if (storedCount !== null) {
            negativeChoicesCount = parseInt(storedCount, 10);
        }

        // ロック状態の確認
        const lockTime = localStorage.getItem('lockTime');
        if (lockTime) {
            const currentTime = new Date().getTime();
            if (currentTime < parseInt(lockTime, 10)) {
                isGameLocked = true;
                showLockedState();
            } else {
                // リセット時間が過ぎていればリセット
                localStorage.removeItem('lockTime');
                localStorage.removeItem('negativeChoicesCount');
            }
        }

        // 初期表示の調整
        if (document.getElementById('game-content').style.display === 'none') {
            document.getElementById('top-page').style.display = 'block';
        }
    };

    function startConversation() {
        if (isGameLocked) {
            displayLockedMessage();
            return;
        }

        // トップページを非表示にし、ゲームコンテンツを表示
        document.getElementById('top-page').style.display = 'none';
        document.getElementById('game-content').style.display = 'block';

        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        // ダイアログをクリアして新しい内容を設定
        dialogue.innerHTML = `
            <div class="character" id="inai-dialogue">
                <img src="komari.png" alt="イナイ">
                <p>実は困ってるんだ・・・</p>
            </div>
        `;
        options.innerHTML = `
            <button onclick="selectOption('how_are_you')">どうしたの？</button>
            <button onclick="selectOption('busy_now')">今忙しいから。</button>
        `;
    }

    function selectOption(option) {
        if (isGameLocked) {
            displayLockedMessage();
            return;
        }

        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        if (option === 'how_are_you') {
            dialogue.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="komari.png" alt="イナイ">
                    <p>地元の○○村が大きな災害に見舞われてしまい、家族と連絡が取れなくなっているんだ。</p>
                </div>
            `;
            options.innerHTML = `
                <button onclick="selectOption('terrible')">それは大変だ</button>
                <button onclick="selectOption('more_difficult')">でも私のほうが大変</button>
            `;
        } else if (option === 'busy_now') {
            handleNegativeChoice();
        } else if (option === 'terrible') {
            dialogue.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="komari.png" alt="イナイ">
                    <p>被災地との通信が困難になったとき、安否確認やメッセージを伝えるためのサービスがあったと思うんだけど… このサービスを利用するためには、どのダイヤルに電話をかけるんだっけ…？</p>
                </div>
            `;
            options.innerHTML = `
                <button onclick="selectOption('think_together')">一緒に考える</button>
                <button onclick="selectOption('dont_know')">それは知らん</button>
            `;
        } else if (option === 'more_difficult') {
            handleNegativeChoice();
        } else if (option === 'think_together') {
            showPhone();
        } else if (option === 'dont_know') {
            handleNegativeChoice();
        }
    }

    function handleNegativeChoice() {
        negativeChoicesCount++;
        console.log('Negative Choices Count:', negativeChoicesCount); // デバッグ用

        // ローカルストレージにカウントを保存
        localStorage.setItem('negativeChoicesCount', negativeChoicesCount);

        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        if (negativeChoicesCount === 1) {
            dialogue.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akire.png" alt="イナイ">
                    <p>そうだよね…ごめんね。</p>
                </div>
            `;
            options.innerHTML = `
                <button onclick="goToTop()">トップページに戻る</button>
            `;
        } else if (negativeChoicesCount === 2) {
            dialogue.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akire.png" alt="イナイ">
                    <p>そうだよね……ごめんね。</p>
                </div>
            `;
            options.innerHTML = `
                <button onclick="goToTop()">トップページに戻る</button>
            `;
        } else if (negativeChoicesCount >= 3) {
            dialogue.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akirame.png" alt="イナイ">
                    <p>……</p>
                </div>
            `;
            options.innerHTML = `
                <button onclick="goToTop()">トップページに戻る</button>
            `;
        }
    }

    function showPhone() {
        if (isGameLocked) {
            displayLockedMessage();
            return;
        }

        const phone = document.getElementById('phone');
        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        phone.style.display = 'block';
        dialogue.innerHTML = `
            <div class="character" id="inai-dialogue">
                <img src="yaruki.png" alt="イナイ">
                <p>適切なダイヤルに電話をかけてください。</p>
            </div>
        `;
        options.innerHTML = `
            <!-- 「電話をかける」ボタンは電話パッド内の1つ -->
        `;
    }

    function dialNumber(num) {
        const phoneDisplay = document.getElementById('phone-display');
        dialedNumber += num;
        phoneDisplay.textContent = `ダイヤル: ${dialedNumber}`;
    }

    function callService() {
        if (isGameLocked) {
            displayLockedMessage();
            return;
        }

        const number = dialedNumber;
        const messageDiv = document.getElementById('message');
        const phone = document.getElementById('phone');
        const options = document.getElementById('options');

        // メッセージ表示前に既存の内容をクリア
        messageDiv.style.display = 'none';
        messageDiv.innerHTML = '';

        if (number === '171') {
            // 成功
            dialogueSuccess();
        } else if (number === '110') {
            // 警察
            messageDiv.style.display = 'block';
            messageDiv.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akire.png" alt="イナイ">
                </div>
                <p>110は警察への電話です。災害通信サービスではありません。</p>
                <button class="back-button" onclick="resetDial()">戻る</button>
            `;
            phone.style.display = 'none';
            options.innerHTML = '';
        } else if (number === '119') {
            // 消防
            messageDiv.style.display = 'block';
            messageDiv.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akire.png" alt="イナイ">
                </div>
                <p>119は消防への電話です。災害通信サービスではありません。</p>
                <button class="back-button" onclick="resetDial()">戻る</button>
            `;
            phone.style.display = 'none';
            options.innerHTML = '';
        } else {
            // その他
            messageDiv.style.display = 'block';
            messageDiv.innerHTML = `
                <div class="character" id="inai-dialogue">
                    <img src="akire.png" alt="イナイ">
                </div>
                <p>無効な番号です。もう一度試してください。</p>
                <button class="back-button" onclick="resetDial()">戻る</button>
            `;
            phone.style.display = 'none';
            options.innerHTML = '';
        }

        // ダイヤル番号をリセット
        dialedNumber = '';
        document.getElementById('phone-display').textContent = 'ダイヤル: ';
    }

    function dialogueSuccess() {
        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');
        const messageDiv = document.getElementById('message');
        const phone = document.getElementById('phone');

        // ダイアログをクリア
        dialogue.innerHTML = `
            <!-- アイコンを削除 -->
        `;

        // メッセージ表示
        messageDiv.style.display = 'block';
        messageDiv.innerHTML = `
            <p>通話成功！災害用伝言ダイヤルに繋がった。</p>
            <p>無事にイナイのパパとママのメッセージを確認できた。</p>
            <button class="back-button" onclick="transitionToEnd()">次へ</button>
        `;

        // 電話パッドを隠す
        phone.style.display = 'none';
        options.innerHTML = '';
    }

    function transitionToEnd() {
        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');
        const messageDiv = document.getElementById('message');
        const endMessage = document.getElementById('end-message');

        // メッセージを非表示にし、dialogueとoptionsをクリア
        messageDiv.style.display = 'none';
        dialogue.innerHTML = '';
        options.innerHTML = '';

        // エンドメッセージを表示
        endMessage.style.display = 'block';
    }

    function receiveReward() {
        window.open('https://line.me/R/oaMessage/%40778unfqy/%E3%82%A4%E3%83%8A%E3%82%A4%E3%81%AE%E6%82%A9%E3%81%BF%E3%82%92%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F', '_blank');
    }

    function goToTop() {
        // トップページに戻る処理
        document.getElementById('game-content').style.display = 'none';
        document.getElementById('lock-message').style.display = 'none';
        document.getElementById('top-page').style.display = 'block';

        // ロック状態の場合の追加処理
        if (isGameLocked) {
            // イナイと話すボタンを押した際の挙動をカスタマイズ
            // 既にロックされている場合はポップアップを表示
            if (!hasShownLockedPopup) {
                alert('今は話しかけてほしくないみたい。また明日話しかけてみよう。');
                hasShownLockedPopup = true;
            }
        }
    }

    function lockGame() {
        isGameLocked = true;
        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        dialogue.innerHTML = `
            <div class="character" id="inai-dialogue">
                <img src="akirame.png" alt="イナイ">
                <p>今は話しかけないで</p>
            </div>
        `;
        options.innerHTML = `
            <button onclick="goToTop()">トップページに戻る</button>
            <p>ゲームはロックされています。</p>
        `;

        // ロックタイムを翌朝6時に設定
        const now = new Date();
        const tomorrow6AM = new Date();
        tomorrow6AM.setDate(now.getDate() + 1);
        tomorrow6AM.setHours(6, 0, 0, 0); // 6:00:00.000

        const timeUntilReset = tomorrow6AM - now;
        localStorage.setItem('lockTime', tomorrow6AM.getTime());

        setTimeout(() => {
            location.reload();
        }, timeUntilReset);
    }

    function displayLockedMessage() {
        const dialogue = document.getElementById('dialogue');
        const options = document.getElementById('options');

        dialogue.innerHTML = `
            <div class="character" id="inai-dialogue">
                <img src="akirame.png" alt="イナイ">
                <p>今は話しかけないで</p>
            </div>
        `;
        options.innerHTML = `
            <button onclick="goToTop()">トップページに戻る</button>
            <p>ゲームはロックされています。</p>
        `;
    }

    function showLockedState() {
        document.getElementById('top-page').style.display = 'none';
        document.getElementById('game-content').style.display = 'block';
        displayLockedMessage();
    }

    function resetDial() {
        dialedNumber = '';
        document.getElementById('phone-display').textContent = 'ダイヤル: ';
        document.getElementById('message').style.display = 'none';
    }

    // デバッグ用: コンソールに選択肢のカウントを表示
    // 否定的な選択肢を選んだ際にカウントが正しく増加しているか確認
</script>

</div>

</body>
</html>
