<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>あいつを探せ！</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* リセットスタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* 上部の情報バー */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            height: 120px; /* 高さを固定 */
        }

        /* HUDのスタイル */
        #hud {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 18px;
            color: #fff; /* 白色に変更 */
        }

        /* 手配書のスタイル */
        #wanted-poster {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            height: 100px; /* 高さをトップバーに収まるように調整 */
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            color: #000;
        }

        #wanted-poster img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        #wanted-poster p {
            margin-top: 10px;
            font-weight: bold;
            font-size: 16px;
            color: #000; /* テキスト色を黒に変更 */
        }

        /* ゲームエリアのスタイル */
        #game-area {
            position: relative;
            flex-grow: 1;
            width: 100%;
            background-color: #333;
            overflow: hidden;
        }

        .character {
            position: absolute;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            transition: transform 0.3s ease;
        }

        /* サイズ変化アニメーション */
        @keyframes sizeVariation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .size-variation {
            animation: sizeVariation 3s infinite;
        }

        /* メッセージのスタイル */
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.85);
            padding: 25px 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 1001;
            display: none;
        }

        #message h2 {
            margin-bottom: 15px;
            color: #fff; /* テキスト色を白に変更 */
            font-size: 24px;
        }

        #message a, #message button {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 25px;
            background-color: #555; /* シンプルなグレーに変更 */
            color: #fff; /* テキスト色を白に変更 */
            text-decoration: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #message a:hover, #message button:hover {
            background-color: #777; /* ホバー時の色を変更 */
            color: #fff;
        }

        /* 暗闇オーバーレイのスタイル */
        #darkness-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 500;
            overflow: hidden;
        }

        .light-spot {
            position: absolute;
            width: 100px; /* 照らす範囲の直径を小さく */
            height: 100px;
            background: radial-gradient(circle at center, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: moveSpot 5s linear infinite;
        }

        @keyframes moveSpot {
            0% {
                top: 0%;
                left: 0%;
            }
            25% {
                top: 0%;
                left: 100%;
            }
            50% {
                top: 100%;
                left: 100%;
            }
            75% {
                top: 100%;
                left: 0%;
            }
            100% {
                top: 0%;
                left: 0%;
            }
        }

        /* レスポンシブ調整 */
        @media (max-width: 600px) {
            #hud {
                font-size: 14px;
            }

            #wanted-poster {
                width: 80px;
                height: 80px;
                padding: 5px;
            }

            #wanted-poster img {
                width: 60px;
                height: 60px;
            }

            .character {
                cursor: pointer;
            }

            #message h2 {
                font-size: 20px;
            }

            #message a, #message button {
                font-size: 16px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- 上部の情報バー -->
        <div id="top-bar">
            <!-- HUD: レベル、タイマー、スコア -->
            <div id="hud">
                <div id="level">レベル: 1</div>
                <div id="timer">残り時間: 15.0秒</div>
                <div id="score">クリア数: 0</div>
            </div>

            <!-- 手配書: 探すキャラクターの表示 -->
            <div id="wanted-poster">
                <img id="target-image" src="" alt="探すキャラクター">
                <p>探せ!!</p>
            </div>
        </div>

        <!-- ゲームエリア: キャラクターが表示される場所 -->
        <div id="game-area"></div>

        <!-- メッセージ表示: ゲームクリアまたはゲームオーバー時 -->
        <div id="message">
            <h2 id="final-message"></h2>
            <a href="https://inaijhs95.github.io/4lamp/?link=1" id="get-link" target="_blank" style="display: none;">♣のトランプをゲットする</a>
            <button id="retry-button" style="display: none;">再チャレンジ</button>
        </div>

        <!-- 暗闇オーバーレイ -->
        <div id="darkness-overlay"></div>
    </div>

    <script>
        // キャラクターの種類（panda.pngを含む）
        const ALL_CHARACTERS = [
            'panda.png',
            'gorilla.png',
            'tengu.png',
            'namahage.png',
            'koala.png'
        ];

        // 探すターゲットキャラクター（panda.pngを除く）
        const TARGET_CHARACTERS = ALL_CHARACTERS.filter(char => char !== 'panda.png');

        // ゲーム設定
        const INITIAL_TIME = 15.0;
        const TIME_DECREMENT = 0.3;
        const MIN_TIME = 5.0;
        const TOTAL_LEVELS = 4;

        // レベルごとの設定
        const levels = [
            {
                name: 'レベル1',
                dynamic: false,
                variableSpeed: false,
                sizeVariation: false,
                darkness: false,
                totalCharacters: 100,
                size: 40
            },
            {
                name: 'レベル2',
                dynamic: true,
                variableSpeed: false,
                sizeVariation: false,
                darkness: false,
                totalCharacters: 100,
                size: 40
            },
            {
                name: 'レベル3',
                dynamic: true,
                variableSpeed: false,
                sizeVariation: false, // サイズ変更を無効化
                darkness: false,
                totalCharacters: 125, // 1.25倍
                size: 32 // 20%小さく
            },
            {
                name: 'レベル4',
                dynamic: true,
                variableSpeed: true,
                sizeVariation: false,
                darkness: false,
                totalCharacters: 100,
                size: 40
            }
        ];

        // ゲームステータス
        let currentLevelIndex = 0;
        let score = 0;
        let timeLimit = INITIAL_TIME;
        let timerInterval = null;
        let darknessInterval = null;

        // DOM要素
        const gameArea = document.getElementById('game-area');
        const levelDisplay = document.getElementById('level');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const wantedPoster = document.getElementById('wanted-poster');
        const targetImage = document.getElementById('target-image');
        const messageDiv = document.getElementById('message');
        const finalMessage = document.getElementById('final-message');
        const getLink = document.getElementById('get-link');
        const retryButton = document.getElementById('retry-button');
        const darknessOverlay = document.getElementById('darkness-overlay');

        // 初期化
        window.onload = startGame;

        // ゲーム開始
        function startGame() {
            currentLevelIndex = 0;
            score = 0;
            timeLimit = INITIAL_TIME;
            scoreDisplay.textContent = `クリア数: ${score}`;
            messageDiv.style.display = 'none';
            startLevel();
        }

        // レベル開始
        function startLevel() {
            if (score >= 4) {
                showFinalMessage(true);
                return;
            }

            if (currentLevelIndex >= levels.length) {
                currentLevelIndex = 0; // レベルをループさせる場合
            }

            const currentLevel = levels[currentLevelIndex];
            levelDisplay.textContent = `${currentLevel.name}`;
            scoreDisplay.textContent = `クリア数: ${score}`;
            timeLimit = Math.max(INITIAL_TIME - TIME_DECREMENT * score, MIN_TIME);
            timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;

            // ゲームエリアをクリア
            gameArea.innerHTML = '';

            // 暗闇設定
            if (currentLevel.darkness) {
                addDarknessEffect();
            } else {
                darknessOverlay.style.display = 'none';
                darknessOverlay.innerHTML = '';
            }

            // 探すターゲットキャラクターをランダムに選択
            const targetCharacter = TARGET_CHARACTERS[Math.floor(Math.random() * TARGET_CHARACTERS.length)];
            targetImage.src = targetCharacter;

            // 画像を配置
            placeCharacters(targetCharacter, currentLevel);

            // タイマー開始
            startTimer();

            // レベルインデックスを更新
            currentLevelIndex++;
        }

        // キャラクターの配置
        function placeCharacters(targetCharacter, levelConfig) {
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;

            const totalCharacters = levelConfig.totalCharacters;
            const targetCount = 1;
            const distractorCount = totalCharacters - targetCount;

            // ターゲットを配置
            const targetPosition = getRandomPosition(areaWidth, areaHeight, levelConfig.size);
            createCharacter(targetCharacter, targetPosition.x, targetPosition.y, true, levelConfig);

            // ディストラクターを配置（panda.pngを含む）
            for (let i = 0; i < distractorCount; i++) {
                let character;
                do {
                    character = ALL_CHARACTERS[Math.floor(Math.random() * ALL_CHARACTERS.length)];
                } while (character === targetCharacter);
                const pos = getRandomPosition(areaWidth, areaHeight, levelConfig.size);
                createCharacter(character, pos.x, pos.y, false, levelConfig);
            }
        }

        // キャラクターの作成
        function createCharacter(character, x, y, isTarget, levelConfig) {
            const img = document.createElement('img');
            img.src = character;
            img.classList.add('character');
            img.style.left = `${x}px`;
            img.style.top = `${y}px`;
            img.dataset.type = isTarget ? 'target' : 'distractor';
            img.style.width = `${levelConfig.size}px`;
            img.style.height = `${levelConfig.size}px`;

            // 動的移動の設定
            if (levelConfig.dynamic) {
                const speed = levelConfig.variableSpeed ? getRandomSpeed() : 2;
                img.dataset.speed = speed;
                moveCharacter(img, speed);
            }

            // サイズ変化の設定（レベル3では無効）
            if (levelConfig.sizeVariation) {
                img.classList.add('size-variation');
            }

            // タップとクリックイベントの設定
            img.addEventListener('click', onCharacterClick);
            img.addEventListener('touchstart', onCharacterClick);

            gameArea.appendChild(img);
        }

        // キャラクターの移動
        function moveCharacter(img, speed) {
            let directionX = Math.random() < 0.5 ? -1 : 1;
            let directionY = Math.random() < 0.5 ? -1 : 1;

            function animate() {
                let x = parseFloat(img.style.left);
                let y = parseFloat(img.style.top);

                const areaWidth = gameArea.clientWidth;
                const areaHeight = gameArea.clientHeight;
                const imgWidth = img.clientWidth;
                const imgHeight = img.clientHeight;

                // 移動
                x += directionX * speed;
                y += directionY * speed;

                // 画面端で方向を反転
                if (x <= 0 || x >= areaWidth - imgWidth) directionX *= -1;
                if (y <= 0 || y >= areaHeight - imgHeight) directionY *= -1;

                img.style.left = `${x}px`;
                img.style.top = `${y}px`;

                // 次のフレームで再度移動
                img.animationFrame = requestAnimationFrame(animate);
            }

            animate();
        }

        // キャラクタークリック時の処理
        function onCharacterClick(event) {
            const type = event.target.dataset.type;
            if (type === 'target') {
                // ターゲットをクリックした場合
                clearInterval(timerInterval);
                if (levels[currentLevelIndex - 1].darkness) {
                    clearInterval(darknessInterval);
                }
                cancelAnimationFrame(event.target.animationFrame);
                score++;
                startLevel();
            } else {
                // ディストラクターをクリックした場合（必要に応じて処理を追加）
                // 例: ミスカウント、エフェクト表示など
            }
        }

        // タイマーの開始
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLimit -= 0.1;
                if (timeLimit <= 0) {
                    clearInterval(timerInterval);
                    gameOver();
                } else {
                    timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
                }
            }, 100);
        }

        // ゲームオーバー時の処理
        function gameOver() {
            // ゲームオーバー処理
            gameArea.innerHTML = '';
            clearInterval(timerInterval);
            if (levels[currentLevelIndex - 1].darkness) {
                clearInterval(darknessInterval);
            }
            messageDiv.style.display = 'block';
            finalMessage.textContent = 'ゲームオーバー！';
            getLink.style.display = 'none';
            retryButton.style.display = 'inline-block';
        }

        // 最終メッセージの表示
        function showFinalMessage(isClear) {
            // ゲームクリア時のメッセージ表示
            gameArea.innerHTML = '';
            messageDiv.style.display = 'block';
            if (isClear) {
                finalMessage.textContent = 'CLEAR!!';
                getLink.style.display = 'inline-block';
                retryButton.style.display = 'none';
            } else {
                finalMessage.textContent = 'もう一度挑戦してください！';
                getLink.style.display = 'none';
                retryButton.style.display = 'inline-block';
            }
        }

        // 暗闇効果の追加
        function addDarknessEffect() {
            darknessOverlay.style.display = 'block';
            darknessOverlay.innerHTML = '';

            // 複数のスポットライトを無作為に生成
            const numberOfSpots = 5; // スポットライトの数
            for (let i = 0; i < numberOfSpots; i++) {
                const spot = document.createElement('div');
                spot.classList.add('light-spot');
                spot.style.animationDelay = `${Math.random() * 5}s`;
                // スポットの開始位置をランダムに設定
                const startX = Math.random() * 100; // パーセンテージ
                const startY = Math.random() * 100; // パーセンテージ
                spot.style.top = `${startY}%`;
                spot.style.left = `${startX}%`;
                darknessOverlay.appendChild(spot);
            }
        }

        // ランダムな位置の取得
        function getRandomPosition(width, height, size) {
            const x = Math.random() * (width - size); // 画像の幅を考慮
            const y = Math.random() * (height - size); // 画像の高さを考慮
            return { x, y };
        }

        // ランダムな速度の取得
        function getRandomSpeed() {
            return Math.random() * 3 + 1; // スピード1〜4
        }

        // リトライボタンの設定
        retryButton.addEventListener('click', () => {
            messageDiv.style.display = 'none';
            startGame();
        });

        // ウィンドウリサイズ時の対応
        window.addEventListener('resize', () => {
            // 必要に応じてゲームエリアの再配置や調整を行います
        });
    </script>
</body>
</html>
