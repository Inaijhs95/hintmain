<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ドラゴンを探せ！</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* リセットスタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #222;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            gap: 20px;
            font-size: 18px;
            color: #fff;
        }

        #game-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .image {
            position: absolute;
            width: 40px;
            height: 40px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }

        .hidden {
            display: none;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1001;
        }

        #message h2 {
            margin-bottom: 10px;
        }

        #message a {
            color: #007BFF;
            text-decoration: none;
            font-size: 18px;
        }

        /* 暗闇効果 */
        #darkness-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            pointer-events: none;
            transition: clip-path 1s linear;
            z-index: 500;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="hud">
            <div id="level">レベル: 1</div>
            <div id="timer">残り時間: 15.0秒</div>
            <div id="score">クリア数: 0</div>
        </div>
        <div id="game-area"></div>
        <div id="message" class="hidden">
            <h2>おめでとうございます！</h2>
            <a href="https://inaijhs95.github.io/4lamp/?link=1" target="_blank">♣のトランプをゲットする</a>
        </div>
        <div id="darkness-overlay" class="hidden"></div>
    </div>

    <script>
        // 画像のパス（必要に応じて変更してください）
        const PANDA_SRC = 'panda.png'; // またはオンライン画像のURL
        const DRAGON_SRC = 'dragon.png'; // またはオンライン画像のURL

        // ゲーム設定
        const TOTAL_IMAGES = 100;
        const INITIAL_TIME = 15.0;
        const TIME_DECREMENT = 0.3;
        const MIN_TIME = 3.0;
        const TOTAL_PATTERNS = 4;

        // レベルごとの設定
        const patterns = [
            {
                name: '静止画',
                dynamic: false,
                variableSpeed: false,
                darkness: false
            },
            {
                name: '無作為に移動',
                dynamic: true,
                variableSpeed: false,
                darkness: false
            },
            {
                name: '暗闇と照らされる範囲の拡大',
                dynamic: false,
                variableSpeed: false,
                darkness: true
            },
            {
                name: '無作為に移動し、スピードがバラバラ',
                dynamic: true,
                variableSpeed: true,
                darkness: false
            }
        ];

        // ゲームステータス
        let currentPatternIndex = 0;
        let score = 0;
        let timeLimit = INITIAL_TIME;
        let timerInterval = null;
        let countdownInterval = null;
        let darknessRadius = 50;
        let darknessInterval = null;

        // DOM要素
        const gameArea = document.getElementById('game-area');
        const levelDisplay = document.getElementById('level');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const messageDiv = document.getElementById('message');
        const darknessOverlay = document.getElementById('darkness-overlay');

        // 初期化
        window.onload = startLevel;

        // 関数定義

        function startLevel() {
            if (score >= 4) {
                // 4問以上正解した場合
                showFinalMessage();
                return;
            }

            const pattern = patterns[currentPatternIndex % TOTAL_PATTERNS];
            levelDisplay.textContent = `レベル: ${currentPatternIndex + 1}`;
            scoreDisplay.textContent = `クリア数: ${score}`;

            // ゲームエリアをクリア
            gameArea.innerHTML = '';

            // 暗闇設定
            if (pattern.darkness) {
                addDarknessEffect();
            } else {
                darknessOverlay.classList.add('hidden');
                darknessOverlay.style.clipPath = 'circle(0px at center)';
            }

            // 画像を配置
            placeImages(pattern);

            // タイマー開始
            startTimer();

            // 次のパターンへ進む準備
            currentPatternIndex++;
        }

        function placeImages(pattern) {
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;

            // ドラゴンのランダム位置
            const dragonPos = getRandomPosition(areaWidth, areaHeight);
            createImage('dragon', DRAGON_SRC, dragonPos.x, dragonPos.y, pattern);

            // パンダを配置
            for (let i = 0; i < TOTAL_IMAGES; i++) {
                const pos = getRandomPosition(areaWidth, areaHeight);
                createImage('panda', PANDA_SRC, pos.x, pos.y, pattern);
            }
        }

        function createImage(type, src, x, y, pattern) {
            const img = document.createElement('img');
            img.src = src;
            img.classList.add('image');
            img.dataset.type = type;
            img.style.left = `${x}px`;
            img.style.top = `${y}px`;

            // 動的移動の設定
            if (pattern.dynamic) {
                const speed = pattern.variableSpeed ? getRandomSpeed() : 2; // スピード設定
                img.dataset.speed = speed;
                moveImage(img, speed);
            }

            // タッチイベントとクリックイベントの設定
            img.addEventListener('click', onImageClick);
            img.addEventListener('touchstart', onImageClick);

            gameArea.appendChild(img);
        }

        function moveImage(img, speed) {
            // ランダムな方向を選択
            let directionX = Math.random() < 0.5 ? -1 : 1;
            let directionY = Math.random() < 0.5 ? -1 : 1;

            function animate() {
                let x = parseFloat(img.style.left);
                let y = parseFloat(img.style.top);

                const areaWidth = gameArea.clientWidth;
                const areaHeight = gameArea.clientHeight;
                const imgWidth = img.clientWidth;
                const imgHeight = img.clientHeight;

                // 移動
                x += directionX * speed;
                y += directionY * speed;

                // 画面端で方向を反転
                if (x <= 0 || x >= areaWidth - imgWidth) directionX *= -1;
                if (y <= 0 || y >= areaHeight - imgHeight) directionY *= -1;

                img.style.left = `${x}px`;
                img.style.top = `${y}px`;

                // 次のフレームで再度移動
                img.animationFrame = requestAnimationFrame(animate);
            }

            animate();
        }

        function onImageClick(event) {
            const type = event.target.dataset.type;
            if (type === 'dragon') {
                // ドラゴンをクリックした場合
                clearInterval(timerInterval);
                clearInterval(countdownInterval);
                clearInterval(darknessInterval);
                cancelAnimationFrame(event.target.animationFrame);
                score++;
                startLevel();
            } else {
                // パンダをクリックした場合（必要に応じて処理を追加）
                // 例: ミスカウント、エフェクト表示など
            }
        }

        function startTimer() {
            timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
            timerInterval = setInterval(() => {
                timeLimit -= 0.1;
                if (timeLimit <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                } else {
                    timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
                }
            }, 100);
        }

        function timeUp() {
            // タイムアップ時の処理
            clearInterval(countdownInterval);
            clearInterval(darknessInterval);
            gameArea.innerHTML = '';
            startLevel();
        }

        function addDarknessEffect() {
            darknessOverlay.classList.remove('hidden');
            darknessRadius = 50;
            darknessOverlay.style.clipPath = `circle(${darknessRadius}px at center)`;

            darknessInterval = setInterval(() => {
                darknessRadius += 50;
                darknessOverlay.style.clipPath = `circle(${darknessRadius}px at center)`;

                // 最大半径を超えたらクリア
                const maxRadius = Math.max(gameArea.clientWidth, gameArea.clientHeight) * 1.5;
                if (darknessRadius >= maxRadius) {
                    clearInterval(darknessInterval);
                }
            }, 1000);
        }

        function getRandomPosition(width, height) {
            const x = Math.random() * (width - 40); // 画像の幅を考慮
            const y = Math.random() * (height - 40); // 画像の高さを考慮
            return { x, y };
        }

        function getRandomSpeed() {
            return Math.random() * 3 + 1; // スピード1〜4
        }

        function showFinalMessage() {
            messageDiv.classList.remove('hidden');
        }

        // ウィンドウリサイズ時の対応
        window.addEventListener('resize', () => {
            // ゲームエリアの再配置や調整が必要な場合はここに追加
        });
    </script>
</body>
</html>
