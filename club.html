// 画像のパス（必要に応じて変更してください）
const PANDA_SRC = 'panda.png';
const DRAGON_SRC = 'dragon.png';

// ゲーム設定
const TOTAL_IMAGES = 100;
const INITIAL_TIME = 15.0;
const TIME_DECREMENT = 0.3;
const MIN_TIME = 3.0;
const TOTAL_LEVELS = 4;

// レベルごとの設定
const levels = [
    {
        name: '静止画',
        dynamic: false,
        movement: false,
        darkness: false
    },
    {
        name: '無作為に移動',
        dynamic: true,
        movement: true,
        darkness: false
    },
    {
        name: '暗闇と照らされる範囲の拡大',
        dynamic: false,
        movement: false,
        darkness: true
    },
    {
        name: '無作為に移動し、スピードがバラバラ',
        dynamic: true,
        movement: true,
        variableSpeed: true,
        darkness: false
    }
];

// ゲームステータス
let currentLevel = 0;
let score = 0;
let timeLimit = INITIAL_TIME;
let timerInterval = null;

// DOM要素
const gameArea = document.getElementById('game-area');
const levelDisplay = document.getElementById('level');
const timerDisplay = document.getElementById('timer');
const scoreDisplay = document.getElementById('score');
const messageDiv = document.getElementById('message');
const modal = document.getElementById('modal');
const modalText = document.getElementById('modal-text');
const modalClose = document.getElementById('modal-close');

// 初期化
startLevel();

// 関数定義

function startLevel() {
    if (currentLevel >= TOTAL_LEVELS) {
        currentLevel = 0; // ループする場合
    }

    const levelConfig = levels[currentLevel];
    levelDisplay.textContent = `レベル: ${currentLevel + 1}`;
    scoreDisplay.textContent = `クリア数: ${score}`;

    // 画面をクリア
    gameArea.innerHTML = '';

    // 暗闇設定
    if (levelConfig.darkness) {
        addDarknessEffect();
    }

    // 画像を配置
    placeImages(levelConfig);

    // タイマー開始
    startTimer();
}

function placeImages(config) {
    // 位置の重複を避けるための座標リスト
    const positions = [];

    // 画面サイズ取得
    const areaWidth = gameArea.clientWidth;
    const areaHeight = gameArea.clientHeight;

    // ドラゴンのランダム位置
    const dragonPos = getRandomPosition(areaWidth, areaHeight);
    positions.push(dragonPos);

    // ドラゴン以外のパンダを配置
    for (let i = 0; i < TOTAL_IMAGES; i++) {
        let pos;
        do {
            pos = getRandomPosition(areaWidth, areaHeight);
        } while (isOverlapping(pos, positions));
        positions.push(pos);

        createImage('panda', PANDA_SRC, pos.x, pos.y, config);
    }

    // ドラゴンを最後に配置
    createImage('dragon', DRAGON_SRC, dragonPos.x, dragonPos.y, config);
}

function createImage(type, src, x, y, config) {
    const img = document.createElement('img');
    img.src = src;
    img.classList.add('image');
    img.dataset.type = type;
    img.style.left = `${x}px`;
    img.style.top = `${y}px`;

    // 動的移動の設定
    if (config.movement) {
        const speed = config.variableSpeed ? getRandomSpeed() : 2; // スピード設定
        img.dataset.speed = speed;
        moveImage(img, speed, config);
    }

    img.addEventListener('click', onImageClick);

    gameArea.appendChild(img);
}

function moveImage(img, speed, config) {
    // ランダムな方向を選択
    let directionX = Math.random() < 0.5 ? -1 : 1;
    let directionY = Math.random() < 0.5 ? -1 : 1;

    function animate() {
        let x = parseFloat(img.style.left);
        let y = parseFloat(img.style.top);

        const areaWidth = gameArea.clientWidth;
        const areaHeight = gameArea.clientHeight;
        const imgWidth = img.clientWidth;
        const imgHeight = img.clientHeight;

        // 移動
        x += directionX * speed;
        y += directionY * speed;

        // 画面端で方向を反転
        if (x <= 0 || x >= areaWidth - imgWidth) directionX *= -1;
        if (y <= 0 || y >= areaHeight - imgHeight) directionY *= -1;

        img.style.left = `${x}px`;
        img.style.top = `${y}px`;

        // 次のフレームで再度移動
        img.animationFrame = requestAnimationFrame(animate);
    }

    animate();
}

function onImageClick(event) {
    const type = event.target.dataset.type;
    if (type === 'dragon') {
        clearInterval(timerInterval);
        score++;
        currentLevel++;
        checkGameClear();
        startLevel();
    } else {
        // パンダをクリックした場合の処理（必要に応じて）
        // 例: ミスカウント、エフェクト表示など
    }
}

function startTimer() {
    timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
    timerInterval = setInterval(() => {
        timeLimit -= 0.1;
        if (timeLimit <= 0) {
            clearInterval(timerInterval);
            timeUp();
        } else {
            timerDisplay.textContent = `残り時間: ${timeLimit.toFixed(1)}秒`;
        }
    }, 100);
}

function timeUp() {
    // ゲームオーバーまたは次のレベルへ
    currentLevel++;
    checkGameClear();
    startLevel();
}

function checkGameClear() {
    if (score >= 4) {
        // ゲームクリア
        gameArea.innerHTML = '';
        messageDiv.classList.remove('hidden');
    } else {
        // 時間を減少
        timeLimit = Math.max(timeLimit - TIME_DECREMENT, MIN_TIME);
    }
}

function addDarknessEffect() {
    // 画面を暗くし、照らされる範囲を拡大
    const darkness = document.createElement('div');
    darkness.id = 'darkness';
    darkness.style.position = 'absolute';
    darkness.style.top = '0';
    darkness.style.left = '0';
    darkness.style.width = '100%';
    darkness.style.height = '100%';
    darkness.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
    darkness.style.pointerEvents = 'none';
    darkness.style.transition = 'clip-path 15s linear';
    gameArea.appendChild(darkness);

    // 初期の照らし範囲
    let radius = 50;
    const maxRadius = Math.max(gameArea.clientWidth, gameArea.clientHeight) * 1.5;

    const interval = setInterval(() => {
        radius += 50;
        if (radius >= maxRadius) {
            clearInterval(interval);
            darkness.style.clipPath = `circle(${maxRadius}px at center)`;
        } else {
            darkness.style.clipPath = `circle(${radius}px at center)`;
        }
    }, 1000);
}

function getRandomPosition(width, height) {
    const x = Math.random() * (width - 50); // 画像の幅を考慮
    const y = Math.random() * (height - 50); // 画像の高さを考慮
    return { x, y };
}

function isOverlapping(pos, positions) {
    for (let p of positions) {
        const dx = pos.x - p.x;
        const dy = pos.y - p.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < 50) { // 画像のサイズを基準に重なり判定
            return true;
        }
    }
    return false;
}

function getRandomSpeed() {
    return Math.random() * 3 + 1; // スピード1〜4
}

// モーダルの処理
modalClose.addEventListener('click', () => {
    modal.classList.add('hidden');
});

function showModal(message) {
    modalText.textContent = message;
    modal.classList.remove('hidden');
}

// ウィンドウリサイズ時の対応
window.addEventListener('resize', () => {
    // ゲームエリアの再配置や調整が必要な場合はここに追加
});
